{
  description = "DeMoD LLC Voice Clone - Multi-Arch Local TTS and Voice Cloning Tools";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    flake-utils.url = "github:numtide/flake-utils";
    tinygrad = {
      url = "github:tinygrad/tinygrad";
      flake = false;
    };
  };

  outputs = { self, nixpkgs, flake-utils, tinygrad }:
    let
      # Define supported systems
      systems = [ "x86_64-linux" "aarch64-linux" ];
      
      # Helper to make packages for a system with specific Python version
      mkPackages = system: pythonVersion:
        let
          pkgs = import nixpkgs {
            inherit system;
            config = {
              allowUnfree = true;
              cudaSupport = false;
              rocmSupport = false;
            };
          };
          
          # Select Python version (311 for Coqui TTS compatibility)
          python = if pythonVersion == "311" then pkgs.python311 else pkgs.python3;
          
          # Create package set with test-disabled overrides
          pythonPkgs = python.pkgs.override {
            overrides = self: super: {
              # Test-disabled packages
              einops = super.einops.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              pytest-doctestplus = super.pytest-doctestplus.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              astropy = super.astropy.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              imageio = super.imageio.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              scikit-image = super.scikit-image.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              moviepy = super.moviepy.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              pyerfa = super.pyerfa.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              tenacity = super.tenacity.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              cloudpathlib = super.cloudpathlib.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              spacy-loggers = super."spacy-loggers".overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              weasel = super.weasel.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              psycopg = super.psycopg.overridePythonAttrs (oldAttrs: {
                disabledTests = [
                  # Timeout-related test failures
                  "test_connect_check_timeout"
                  "test_eintr"
                  # Connection timing issues
                  "test_connect_error_multi_hosts_each_message_preserved"
                  "test_break_attempts"
                  "test_wait_r"
                ];
                disabledTestPaths = [
                  # Network-dependent tests that may timeout
                  "tests/test_dns.py"
                  "tests/test_dns_srv.py"
                ];
                disabledTestMarks = [
                  "timing"
                  "flakey"
                ];
                pytestFlags = [ "--timeout=300" ];  # 5 minute timeout
              });
              pytest-timeout = super.pytest-timeout.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              sh = super.sh.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              python-dotenv = super."python-dotenv".overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              flask = super.flask.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              azure-core = super."azure-core".overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              "factory-boy" = super."factory-boy".overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              flasgger = super.flasgger.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              "flask-cors" = super."flask-cors".overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              "flask-sqlalchemy" = super."flask-sqlalchemy".overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              "google-auth" = super."google-auth".overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              httpbin = super.httpbin.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              moto = super.moto.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              respx = super.respx.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              "smart-open" = super."smart-open".overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });
              wandb = super.wandb.overridePythonAttrs (oldAttrs: {
                doCheck = false;
              });

              # Coqui TTS compatibility overrides
              trainer = pythonPkgs.buildPythonPackage rec {
                pname = "trainer";
                version = "0.0.36";
                format = "pyproject";
                src = pkgs.fetchPypi {
                  pname = "trainer";
                  inherit version;
                  hash = pkgs.lib.fakeSha256 0000000000000000000000000000000000000000000000;
                };
                propagatedBuildInputs = with pythonPkgs; [ coqpit psutil torch ];
                doCheck = false;
              };

              pandas = pythonPkgs.buildPythonPackage rec {
                pname = "pandas";
                version = "1.5.3";
                format = "pyproject";
                src = pkgs.fetchPypi {
                  pname = "pandas";
                  inherit version;
                  hash = pkgs.lib.fakeSha256 0000000000000000000000000000000000000000000000;
                };
                propagatedBuildInputs = with pythonPkgs; [ python-dateutil numpy pytz tzdata ];
                doCheck = false;
              };

          
               # Pin Cython to version compatible with Coqui TTS
              cython' = pythonPkgs.cython.overridePythonAttrs (oldAttrs: {
                version = "0.29.37";
                src = pkgs.fetchPypi {
                  pname = "Cython";
                  version = "0.29.37";
                  sha256 = "sha256-+BPUpt2Ure5dT/JmGR0dlb9tQWSk+sxTVCLAIbJQTPs=";
                };
              });

              # Build Coqui TTS with specific Python
              coqui-tts = pythonPkgs.buildPythonPackage rec {
                pname = "TTS";
                version = "0.22.0";
                format = "pyproject";
                
                src = pkgs.fetchFromGitHub {
                  owner = "coqui-ai";
                  repo = "TTS";
                  rev = "v${version}";
                  sha256 = "sha256-RQVlPHYZ5X/6xbxwGNcgntcyAsBS8T2ketdk+OCIS3Q=";
                };
                
                nativeBuildInputs = with pythonPkgs; [
                  setuptools
                  wheel
                  cython'
                ];

                propagatedBuildInputs = with pythonPkgs; [
                  numpy
                  scipy
                  torch
                  torchaudio
                  librosa
                  soundfile
                  inflect
                  tqdm
                  packaging
                  numba
                  einops
                  transformers
                  tokenizers
                  coqpit
                  pyyaml
                  fsspec
                  pydub
                  gruut
                  bangla
                  jamo
                  pypinyin
                  mecab-python3
                  unidic-lite
                  # Additional Coqui TTS dependencies
                  anyascii
                  aiohttp
                  flask
                  pysbd
                  umap-learn
                  pandas
                  matplotlib
                  trainer
                  jieba
                  nltk
                  encodec
                  unidecode
                  spacy
                ] ++ (with pythonPkgs; [
                  # Language-specific packages that might not be in nixpkgs
                  # These are optional and build will skip if not found
                ]);

                doCheck = false;
                
                pythonImportsCheck = [ "TTS" ];
              };
            
            # Build Python environment
          pythonEnv = python.withPackages (ps: with ps; [
            coqui-tts
            torch
            torchaudio
            torchvision
            pytorch-lightning
            onnxruntime
            numpy
            scipy
            librosa
            pydub
            pyyaml
            fsspec
            soundfile
            tqdm
          ]);
          
          # Build demod-voice package
          demod-voice = pythonPkgs.buildPythonPackage {
            pname = "demod-voice";
            version = "1.0.0";
            src = ./.;
            format = "other";
            
            propagatedBuildInputs = with pythonPkgs; [ pyyaml tqdm ];
            nativeBuildInputs = [ pkgs.makeWrapper ];
            
            installPhase = ''
              mkdir -p $out/${python.sitePackages}/demod_voice
              mkdir -p $out/bin
              
              cp -r demod_voice/* $out/${python.sitePackages}/demod_voice/
              touch $out/${python.sitePackages}/demod_voice/__init__.py
              
              cp bin/demod-voice $out/bin/demod-voice
              chmod +x $out/bin/demod-voice
              
              wrapProgram $out/bin/demod-voice \
                --prefix PATH : ${pkgs.lib.makeBinPath [ pkgs.piper-tts pkgs.ffmpeg pkgs.sox ]} \
                --set PYTHONPATH "${pythonEnv}/${python.sitePackages}:$out/${python.sitePackages}"
            '';
            
            checkInputs = with pythonPkgs; [ pytest ];
            checkPhase = ''
              export PYTHONPATH="$out/${python.sitePackages}:${pythonEnv}/${python.sitePackages}:$PYTHONPATH"
              pytest tests/test_config.py tests/test_batch.py -v || true
            '';
            
            meta = with pkgs.lib; {
              description = "DeMoD LLC Voice Clone";
              license = licenses.mit;
              platforms = platforms.linux;
            };
          };
          
        in {
          inherit demod-voice pythonEnv python pythonPkgs;
        };
      
      # Build Docker image helper
      mkDockerImage = { pkgs, demod-voice, pythonEnv, python, backend, arch, extraLibs ? [] }:
        let
          version = "1.0.0";
          
          backendEnv = 
            if backend == "cuda" then [
              "NVIDIA_VISIBLE_DEVICES=all"
              "NVIDIA_DRIVER_CAPABILITIES=compute,utility"
            ]
            else if backend == "rocm" then [
              "HSA_OVERRIDE_GFX_VERSION=10.3.0"
              "ROCM_PATH=/opt/rocm"
            ]
            else [];
            
        in
        pkgs.dockerTools.buildLayeredImage {
          name = "demod-voice";
          tag = "${version}-${backend}-${arch}";
          
          contents = [
            demod-voice
            pythonEnv
            pkgs.piper-tts
            pkgs.ffmpeg
            pkgs.sox
            pkgs.bashInteractive
            pkgs.coreutils
            pkgs.cacert
          ] ++ extraLibs;

          config = {
            Cmd = [ "${demod-voice}/bin/demod-voice" "--help" ];
            Env = [
              "PATH=/bin:${pkgs.lib.makeBinPath ([ pkgs.piper-tts pkgs.ffmpeg pkgs.sox ] ++ extraLibs)}"
              "PYTHONUNBUFFERED=1"
              "PYTHONPATH=${pythonEnv}/${python.sitePackages}:${demod-voice}/${python.sitePackages}"
              "HOME=/tmp"
              "TTS_HOME=/tmp/.local/share/tts"
            ] ++ backendEnv;
            WorkingDir = "/workspace";
            Volumes = {
              "/workspace" = {};
            };
          };
          
          maxLayers = 100;
        };
        
    in
    flake-utils.lib.eachSystem systems (system:
      let
        # Use Python 3.11 for Coqui TTS compatibility (requires < 3.12)
        basePkgs = mkPackages system "311";
        
        arch = if system == "x86_64-linux" then "amd64" else "arm64";
        
        # Base imports for checks and devShell
        pkgs = import nixpkgs {
          inherit system;
          config = {
            allowUnfree = true;
            cudaSupport = false;
            rocmSupport = false;
          };
        };
        
        # CUDA variant
        cudaPkgs = import nixpkgs {
          inherit system;
          config = {
            allowUnfree = true;
            cudaSupport = true;
          };
        };
        
        cudaBase = mkPackages system "311";
        
        dockerImage-cuda = mkDockerImage {
          pkgs = cudaPkgs;
          inherit (cudaBase) demod-voice pythonEnv;
          python = cudaBase.python;
          backend = "cuda";
          inherit arch;
          extraLibs = [ cudaPkgs.cudaPackages.cudatoolkit ];
        };
        
        # ROCm variant
        rocmPkgs = import nixpkgs {
          inherit system;
          config = {
            allowUnfree = true;
            rocmSupport = true;
          };
        };
        
        rocmBase = mkPackages system "311";
        
        dockerImage-rocm = mkDockerImage {
          pkgs = rocmPkgs;
          inherit (rocmBase) demod-voice pythonEnv;
          python = rocmBase.python;
          backend = "rocm";
          inherit arch;
          extraLibs = [ rocmPkgs.rocmPackages.rocm-runtime ];
        };
        
        # CPU variant
        dockerImage-cpu = mkDockerImage {
          inherit pkgs;
          inherit (basePkgs) demod-voice pythonEnv python;
          backend = "cpu";
          inherit arch;
        };
        
      in {
        packages = {
          # Base package
          demod-voice = basePkgs.demod-voice;
          default = basePkgs.demod-voice;
          python-env = basePkgs.pythonEnv;
          
          # Docker images for each backend
          inherit dockerImage-cpu dockerImage-cuda dockerImage-rocm;
          
          # Aliases with full tag names
          "dockerImage-cpu-${arch}" = dockerImage-cpu;
          "dockerImage-cuda-${arch}" = dockerImage-cuda;
          "dockerImage-rocm-${arch}" = dockerImage-rocm;
        };

        apps = {
          demod-voice = {
            type = "app";
            program = "${basePkgs.demod-voice}/bin/demod-voice";
          };
          default = {
            type = "app";
            program = "${basePkgs.demod-voice}/bin/demod-voice";
          };
        };

        checks = {
          cli-help = pkgs.runCommand "test-cli-help" {
            buildInputs = [ basePkgs.demod-voice ];
          } ''
            ${basePkgs.demod-voice}/bin/demod-voice --help > $out
          '';
          
          health-check = pkgs.runCommand "test-health-check" {
            buildInputs = [ basePkgs.demod-voice ];
          } ''
            ${basePkgs.demod-voice}/bin/demod-voice health --json > $out
          '';
        };

        devShells.default = pkgs.mkShell {
          packages = [
            basePkgs.pythonEnv
            basePkgs.demod-voice
            pkgs.piper-tts
            pkgs.git
            pkgs.ffmpeg
            pkgs.sox
            pkgs.python311Packages.black
            pkgs.python311Packages.ruff
            pkgs.python311Packages.mypy
            pkgs.python311Packages.pytest
          ] ++ pkgs.lib.optionals pkgs.stdenv.isLinux [
            pkgs.cudaPackages.cudatoolkit
            pkgs.vulkan-loader
          ];

          shellHook = ''
            echo "========================================"
            echo "DeMoD LLC Voice Clone Dev Environment"
            echo "Architecture: ${arch}"
            echo "Python: 3.11 (for Coqui TTS compatibility)"
            echo "========================================"
            echo ""
            echo "Available Docker builds:"
            echo "  nix build .#dockerImage-cpu-${arch}"
            echo "  nix build .#dockerImage-cuda-${arch}"
            echo "  nix build .#dockerImage-rocm-${arch}"
            echo ""
            echo "CLI usage: demod-voice --help"
            echo ""
          '';

          LD_LIBRARY_PATH = pkgs.lib.makeLibraryPath (
            pkgs.lib.optionals pkgs.stdenv.isLinux [
              pkgs.stdenv.cc.cc.lib
              pkgs.cudaPackages.cudatoolkit
            ]
          );
        };
      }
    );
}